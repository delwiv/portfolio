import { sanityFetch } from '~/sanity/lib/live'
import {
  DEVELOPER_QUERY,
  PROJECTS_QUERY,
  SKILLS_QUERY,
} from '~/sanity/lib/queries'
import { parseHeaders } from '~/utils/headers'

import ReactPDF, { renderToBuffer } from '@react-pdf/renderer'
import PdfDoc from '~/components/PdfDoc'

export const contentType = 'application/pdf'

export async function GET() {
  const { locale: language } = await parseHeaders()

  const [{ data: developer }, { data: skills }, { data: projects }] =
    await Promise.all([
      sanityFetch({ query: DEVELOPER_QUERY, params: { language } }),
      sanityFetch({ query: SKILLS_QUERY, params: { language, limit: 150 } }),
      sanityFetch({ query: PROJECTS_QUERY, params: { language, limit: 150 } }),
    ])

  const Doc = PdfDoc({ developer, skills, projects })
  return new Response(await renderToBuffer(<Doc />), {
    headers: {
      'Content-Type': 'application/pdf',
    },
  })
}
